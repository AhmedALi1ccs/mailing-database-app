#!/bin/bash
set -e

# If running the rails server, wait for the database to be ready
if [ "${1}" == "./bin/rails" ] && [ "${2}" == "server" ]; then
  # Check if database exists
  until bundle exec rails db:migrate:status &> /dev/null; do
    echo "Database is not ready - sleeping"
    sleep 2
  done
  
  # Run pending migrations
  bundle exec rails db:migrate
fi

# Then exec the container's main process (what's set as CMD in the Dockerfile)
exec "${@}"